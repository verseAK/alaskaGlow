<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alaska Glow ‚Äî Aurora Forecast for Tonight</title>
<meta name="description" content="Will you see the northern lights tonight in Alaska? Real-time aurora forecast for Fairbanks, Anchorage, Palmer, Denali, Kenai, and Juneau. Simple, clear, no science degree needed.">
<meta property="og:title" content="Alaska Glow ‚Äî Aurora Forecast for Tonight">
<meta property="og:description" content="Will you see the northern lights tonight? Check your Alaska location now.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://alaskaglow.com">
<meta property="og:site_name" content="Alaska Glow">
<meta name="twitter:card" content="summary_large_image">
<link rel="canonical" href="https://alaskaglow.com">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fraunces:opsz,wght@9..144,300;9..144,500;9..144,700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.9.0/suncalc.min.js"></script>
<style>
:root {
  --bg-deep: #050a0f;
  --bg-card: #0c1a1f;
  --bg-card-hover: #112228;
  --green-glow: #2ecc71;
  --yellow-glow: #f1c40f;
  --orange-glow: #e67e22;
  --red-glow: #e74c3c;
  --text-primary: #e8f0f2;
  --text-secondary: #8ba4ad;
  --text-muted: #4a6670;
  --aurora-green: #4ade80;
  --aurora-teal: #2dd4bf;
  --aurora-purple: #a78bfa;
  --border: #1a2e35;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Outfit',sans-serif; background:var(--bg-deep); color:var(--text-primary); min-height:100vh; overflow-x:hidden; }

/* Aurora background */
.aurora-bg { position:fixed; top:0;left:0;right:0;bottom:0; z-index:0; overflow:hidden; pointer-events:none; }
.aurora-band { position:absolute; width:200%; height:300px; top:-80px; left:-50%; filter:blur(60px); animation:aurora-drift 20s ease-in-out infinite; }
.aurora-band:nth-child(1) { background:radial-gradient(ellipse at center,rgba(46,204,113,0.12) 0%,rgba(45,212,191,0.06) 30%,rgba(167,139,250,0.04) 60%,transparent 80%); }
.aurora-band:nth-child(2) { top:-40px; animation-delay:-7s; animation-duration:25s; opacity:0.7; background:radial-gradient(ellipse at center,rgba(45,212,191,0.1) 0%,rgba(167,139,250,0.06) 40%,transparent 70%); }
.aurora-band:nth-child(3) { top:-120px; animation-delay:-14s; animation-duration:30s; opacity:0.5; background:radial-gradient(ellipse at center,rgba(167,139,250,0.08) 0%,rgba(46,204,113,0.04) 40%,transparent 70%); }
@keyframes aurora-drift { 0%,100%{transform:translateX(-10%) rotate(-2deg)} 33%{transform:translateX(5%) rotate(1deg)} 66%{transform:translateX(-5%) rotate(-1deg)} }
.star { position:absolute; width:2px; height:2px; background:white; border-radius:50%; animation:twinkle 3s ease-in-out infinite; }
@keyframes twinkle { 0%,100%{opacity:0.3} 50%{opacity:0.8} }

.container { position:relative; z-index:1; max-width:900px; margin:0 auto; padding:0 20px; }
header { padding:40px 0 20px; text-align:center; }
.logo { font-family:'Fraunces',serif; font-size:2.2rem; font-weight:700; background:linear-gradient(135deg,var(--aurora-green),var(--aurora-teal),var(--aurora-purple)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; letter-spacing:-0.02em; margin-bottom:4px; cursor:pointer; }
.tagline { font-size:0.95rem; color:var(--text-secondary); font-weight:300; }

/* Loading */
.loading-state { text-align:center; padding:80px 20px; }
.loading-spinner { width:40px; height:40px; border:3px solid var(--border); border-top-color:var(--aurora-green); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 16px; }
@keyframes spin { to{transform:rotate(360deg)} }

/* Section label */
.section-label { font-size:0.8rem; font-weight:500; text-transform:uppercase; letter-spacing:0.12em; color:var(--text-muted); margin:32px 0 16px; padding-left:4px; }

/* Last updated */
.last-updated { text-align:center; font-size:0.75rem; color:var(--text-muted); margin-bottom:8px; }

/* Hero card */
.hero { margin:24px 0; padding:32px; border-radius:20px; text-align:center; position:relative; overflow:hidden; cursor:pointer; transition:transform 0.2s; }
.hero:hover { transform:scale(1.01); }
.hero.level-great { background:linear-gradient(135deg,rgba(46,204,113,0.15),rgba(45,212,191,0.08)); border:1px solid rgba(46,204,113,0.3); }
.hero.level-possible { background:linear-gradient(135deg,rgba(241,196,15,0.12),rgba(241,196,15,0.04)); border:1px solid rgba(241,196,15,0.25); }
.hero.level-cloudy { background:linear-gradient(135deg,rgba(230,126,34,0.12),rgba(230,126,34,0.04)); border:1px solid rgba(230,126,34,0.25); }
.hero.level-unlikely { background:linear-gradient(135deg,rgba(231,76,60,0.1),rgba(231,76,60,0.03)); border:1px solid rgba(231,76,60,0.2); }
.hero-eyebrow { font-size:0.8rem; font-weight:500; text-transform:uppercase; letter-spacing:0.12em; color:var(--text-secondary); margin-bottom:12px; }
.hero-location { font-family:'Fraunces',serif; font-size:1.6rem; font-weight:500; margin-bottom:8px; }
.hero-verdict { font-size:1.05rem; font-weight:400; margin-bottom:16px; line-height:1.5; }
.hero-detail { font-size:0.85rem; color:var(--text-secondary); }
.hero-detail strong { color:var(--text-primary); font-weight:500; }

/* 3-Night Outlook */
.outlook-strip { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
.outlook-card { background:var(--bg-card); border:1px solid var(--border); border-radius:14px; padding:16px 14px; text-align:center; transition:all 0.2s; }
.outlook-card:hover { background:var(--bg-card-hover); }
.outlook-card.is-tonight { border-color:rgba(255,255,255,0.12); }
.outlook-day { font-size:0.78rem; font-weight:500; color:var(--text-secondary); margin-bottom:10px; text-transform:uppercase; letter-spacing:0.06em; }
.outlook-indicator { width:18px; height:18px; border-radius:50%; margin:0 auto 10px; }
.outlook-indicator.level-great { background:var(--green-glow); box-shadow:0 0 16px var(--green-glow); }
.outlook-indicator.level-possible { background:var(--yellow-glow); box-shadow:0 0 16px var(--yellow-glow); }
.outlook-indicator.level-cloudy { background:var(--orange-glow); box-shadow:0 0 16px var(--orange-glow); }
.outlook-indicator.level-unlikely { background:var(--red-glow); box-shadow:0 0 12px var(--red-glow); }
.outlook-label { font-size:0.85rem; font-weight:500; color:var(--text-primary); margin-bottom:4px; }
.outlook-desc { font-size:0.75rem; color:var(--text-muted); line-height:1.4; }

/* Location cards grid */
.locations-grid { display:grid; grid-template-columns:1fr; gap:12px; margin-bottom:24px; }
@media(min-width:600px) { .locations-grid { grid-template-columns:1fr 1fr; } }
.location-card { background:var(--bg-card); border:1px solid var(--border); border-radius:16px; padding:20px; cursor:pointer; transition:all 0.2s; position:relative; overflow:hidden; }
.location-card:hover { background:var(--bg-card-hover); transform:translateY(-2px); border-color:rgba(255,255,255,0.1); }
.location-card::before { content:''; position:absolute; top:0; left:0; width:4px; height:100%; border-radius:4px 0 0 4px; }
.location-card.level-great::before { background:var(--green-glow); }
.location-card.level-possible::before { background:var(--yellow-glow); }
.location-card.level-cloudy::before { background:var(--orange-glow); }
.location-card.level-unlikely::before { background:var(--red-glow); }
.card-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
.card-location-name { font-weight:600; font-size:1.05rem; }
.card-indicator { width:12px; height:12px; border-radius:50%; flex-shrink:0; }
.level-great .card-indicator { background:var(--green-glow); box-shadow:0 0 12px var(--green-glow); }
.level-possible .card-indicator { background:var(--yellow-glow); box-shadow:0 0 12px var(--yellow-glow); }
.level-cloudy .card-indicator { background:var(--orange-glow); box-shadow:0 0 12px var(--orange-glow); }
.level-unlikely .card-indicator { background:var(--red-glow); box-shadow:0 0 12px var(--red-glow); }
.card-verdict { font-size:0.92rem; color:var(--text-secondary); line-height:1.5; margin-bottom:10px; }
.card-meta { display:flex; gap:16px; font-size:0.78rem; color:var(--text-muted); }
.card-meta span { display:flex; align-items:center; gap:4px; }

/* Forecast bars */
.forecast-section { margin:32px 0; background:var(--bg-card); border:1px solid var(--border); border-radius:16px; padding:24px; }
.forecast-title { font-weight:600; font-size:1rem; margin-bottom:4px; }
.forecast-subtitle { font-size:0.82rem; color:var(--text-secondary); margin-bottom:20px; }
.forecast-chart { display:flex; align-items:flex-end; gap:3px; height:120px; padding:0 4px; }
.forecast-bar-group { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; justify-content:flex-end; }
.forecast-bar { width:100%; max-width:28px; border-radius:4px 4px 0 0; min-height:4px; transition:all 0.3s; }
.forecast-bar.is-night { opacity:1; }
.forecast-bar.is-day { opacity:0.25; }
.forecast-bar.kp-low { background:var(--red-glow); }
.forecast-bar.kp-mod { background:var(--yellow-glow); }
.forecast-bar.kp-high { background:var(--green-glow); }
.forecast-bar.kp-storm { background:var(--aurora-purple); }
.forecast-time { font-size:0.6rem; color:var(--text-muted); margin-top:6px; text-align:center; white-space:nowrap; }
.forecast-time.is-tonight { color:var(--text-secondary); font-weight:500; }
.forecast-legend { display:flex; gap:16px; margin-top:16px; font-size:0.75rem; color:var(--text-muted); flex-wrap:wrap; }
.legend-item { display:flex; align-items:center; gap:5px; }
.legend-dot { width:8px; height:8px; border-radius:2px; }
.forecast-empty { text-align:center; padding:30px; color:var(--text-muted); font-size:0.85rem; }

/* Alert signup */
.alert-section { margin:32px 0; background:linear-gradient(135deg,rgba(45,212,191,0.08),rgba(167,139,250,0.05)); border:1px solid rgba(45,212,191,0.2); border-radius:16px; padding:28px; text-align:center; }
.alert-title { font-family:'Fraunces',serif; font-size:1.3rem; font-weight:500; margin-bottom:8px; }
.alert-desc { font-size:0.9rem; color:var(--text-secondary); margin-bottom:20px; max-width:420px; margin-left:auto; margin-right:auto; line-height:1.5; }
.alert-form { display:flex; gap:8px; max-width:400px; margin:0 auto; }
.alert-input { flex:1; padding:12px 16px; border-radius:10px; border:1px solid var(--border); background:var(--bg-deep); color:var(--text-primary); font-family:'Outfit',sans-serif; font-size:0.9rem; outline:none; transition:border-color 0.2s; }
.alert-input:focus { border-color:var(--aurora-teal); }
.alert-input::placeholder { color:var(--text-muted); }
.alert-btn { padding:12px 20px; border-radius:10px; border:none; background:linear-gradient(135deg,var(--aurora-teal),var(--aurora-green)); color:var(--bg-deep); font-family:'Outfit',sans-serif; font-weight:600; font-size:0.9rem; cursor:pointer; transition:all 0.2s; white-space:nowrap; }
.alert-btn:hover { transform:scale(1.03); box-shadow:0 0 20px rgba(45,212,191,0.3); }
.alert-success { display:none; color:var(--aurora-green); font-size:0.9rem; margin-top:12px; }

/* Last night section */
.lastnight-section { margin:32px 0; background:var(--bg-card); border:1px solid var(--border); border-radius:16px; padding:24px; }
.lastnight-header { display:flex; align-items:center; gap:10px; margin-bottom:8px; }
.lastnight-header h3 { font-size:1rem; font-weight:600; }
.lastnight-desc { font-size:0.88rem; color:var(--text-secondary); line-height:1.5; }

/* Tours section */
.tours-grid { display:grid; grid-template-columns:1fr; gap:12px; }
@media(min-width:600px) { .tours-grid { grid-template-columns:1fr 1fr; } }
.tour-card { background:var(--bg-card); border:1px solid var(--border); border-radius:14px; padding:18px; display:flex; gap:14px; align-items:center; text-decoration:none; color:inherit; transition:all 0.2s; }
.tour-card:hover { background:var(--bg-card-hover); border-color:rgba(255,255,255,0.1); transform:translateY(-1px); }
.tour-icon { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:1.3rem; flex-shrink:0; background:rgba(45,212,191,0.1); }
.tour-info h3 { font-size:0.92rem; font-weight:600; margin-bottom:2px; }
.tour-info p { font-size:0.8rem; color:var(--text-secondary); line-height:1.4; }

/* SEO section */
.seo-section { margin:40px 0; padding:28px; background:var(--bg-card); border:1px solid var(--border); border-radius:16px; }
.seo-section h2 { font-family:'Fraunces',serif; font-size:1.3rem; font-weight:500; margin-bottom:12px; }
.seo-section p { font-size:0.9rem; color:var(--text-secondary); line-height:1.7; margin-bottom:12px; }
.seo-section p:last-child { margin-bottom:0; }

/* Location detail page */
.location-detail { display:none; }
.location-detail.active { display:block; }
.back-btn { display:inline-flex; align-items:center; gap:6px; color:var(--text-secondary); font-size:0.85rem; cursor:pointer; padding:8px 0; margin-bottom:16px; border:none; background:none; font-family:'Outfit',sans-serif; transition:color 0.2s; }
.back-btn:hover { color:var(--text-primary); }

.detail-hero { padding:32px; border-radius:20px; margin-bottom:24px; text-align:center; }
.detail-hero.level-great { background:linear-gradient(135deg,rgba(46,204,113,0.15),rgba(45,212,191,0.08)); border:1px solid rgba(46,204,113,0.3); }
.detail-hero.level-possible { background:linear-gradient(135deg,rgba(241,196,15,0.12),rgba(241,196,15,0.04)); border:1px solid rgba(241,196,15,0.25); }
.detail-hero.level-cloudy { background:linear-gradient(135deg,rgba(230,126,34,0.12),rgba(230,126,34,0.04)); border:1px solid rgba(230,126,34,0.25); }
.detail-hero.level-unlikely { background:linear-gradient(135deg,rgba(231,76,60,0.1),rgba(231,76,60,0.03)); border:1px solid rgba(231,76,60,0.2); }
.detail-location-name { font-family:'Fraunces',serif; font-size:1.8rem; font-weight:500; margin-bottom:8px; }
.detail-verdict-large { font-size:1.1rem; margin-bottom:16px; line-height:1.5; }
.detail-stats { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; margin-top:20px; }
.detail-stat { text-align:center; }
.detail-stat-value { font-size:1.4rem; font-weight:600; margin-bottom:2px; }
.detail-stat-label { font-size:0.75rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.06em; }

.info-card { background:var(--bg-card); border:1px solid var(--border); border-radius:14px; padding:20px; margin-bottom:12px; }
.info-card h3 { font-size:0.9rem; font-weight:600; margin-bottom:8px; display:flex; align-items:center; gap:8px; }
.info-card p { font-size:0.85rem; color:var(--text-secondary); line-height:1.6; }

.spot-list { list-style:none; padding:0; }
.spot-list li { padding:10px 0; border-bottom:1px solid var(--border); font-size:0.88rem; }
.spot-list li:last-child { border-bottom:none; }
.spot-name { font-weight:600; color:var(--text-primary); }
.spot-desc { color:var(--text-secondary); margin-top:2px; line-height:1.4; }

.share-btn { display:inline-flex; align-items:center; gap:6px; padding:10px 18px; border-radius:10px; border:1px solid var(--border); background:var(--bg-card); color:var(--text-secondary); font-family:'Outfit',sans-serif; font-size:0.85rem; cursor:pointer; transition:all 0.2s; margin-top:16px; }
.share-btn:hover { background:var(--bg-card-hover); color:var(--text-primary); border-color:var(--aurora-teal); }

.detail-nerd { cursor:pointer; }
.nerd-data { display:none; margin-top:8px; }
.nerd-data p { margin-top:0; }

/* Other locations strip on detail page */
.other-locations { display:flex; gap:8px; overflow-x:auto; padding-bottom:8px; margin:16px 0; }
.other-loc-chip { flex-shrink:0; padding:8px 16px; border-radius:20px; background:var(--bg-card); border:1px solid var(--border); font-size:0.82rem; color:var(--text-secondary); cursor:pointer; transition:all 0.2s; display:flex; align-items:center; gap:6px; }
.other-loc-chip:hover { background:var(--bg-card-hover); color:var(--text-primary); }
.chip-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

footer { text-align:center; padding:40px 0; font-size:0.78rem; color:var(--text-muted); line-height:1.7; }
footer a { color:var(--text-secondary); text-decoration:none; }
footer a:hover { color:var(--text-primary); }
</style>
</head>
<body>
<div class="aurora-bg">
  <div class="aurora-band"></div>
  <div class="aurora-band"></div>
  <div class="aurora-band"></div>
  <div class="stars" id="stars"></div>
</div>

<div class="container">
  <header>
    <div class="logo" onclick="navigateTo('')">Alaska Glow</div>
    <div class="tagline">Will you see the northern lights tonight?</div>
  </header>

  <div id="loading" class="loading-state">
    <div class="loading-spinner"></div>
    <div class="loading-text" style="color:var(--text-secondary);font-size:0.9rem;">Checking aurora conditions...</div>
  </div>

  <!-- ==================== DASHBOARD ==================== -->
  <div id="dashboard" style="display:none;">
    <div class="last-updated" id="lastUpdated"></div>

    <div id="heroCard" class="hero level-possible">
      <div class="hero-eyebrow">‚ú¶ Best spot tonight</div>
      <div class="hero-location" id="heroLocation">‚Äî</div>
      <div class="hero-verdict" id="heroVerdict"></div>
      <div class="hero-detail" id="heroDetail"></div>
    </div>

    <div class="section-label">3-Night Outlook</div>
    <div class="outlook-strip" id="outlookStrip"></div>

    <div class="section-label">All locations tonight</div>
    <div class="locations-grid" id="locationsGrid"></div>

    <!-- Was last night good? -->
    <div class="lastnight-section" id="lastnightSection" style="display:none;">
      <div class="lastnight-header">
        <span style="font-size:1.2rem;">üåå</span>
        <h3 id="lastnightTitle">Was last night good?</h3>
      </div>
      <div class="lastnight-desc" id="lastnightDesc"></div>
    </div>

    <!-- 3-Day Activity Forecast -->
    <div class="forecast-section">
      <div class="forecast-title">3-Day Activity Forecast</div>
      <div class="forecast-subtitle">Taller bars = stronger aurora activity. Bright bars = nighttime (when you can see them).</div>
      <div class="forecast-chart" id="forecastChart"></div>
      <div class="forecast-legend" id="forecastLegend" style="display:none;">
        <div class="legend-item"><div class="legend-dot" style="background:var(--red-glow)"></div> Quiet</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--yellow-glow)"></div> Moderate</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--green-glow)"></div> Active</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--aurora-purple)"></div> Storm</div>
        <div class="legend-item"><span style="opacity:0.3">‚ñê</span> Daytime</div>
      </div>
    </div>

    <!-- Alert signup -->
    <div class="alert-section">
      <div class="alert-title">Get notified when it's go time</div>
      <div class="alert-desc">We'll email you when aurora conditions look great for your location. No spam, just glow.</div>
      <div class="alert-form" id="alertForm">
        <input type="email" class="alert-input" placeholder="your@email.com" id="alertEmail">
        <button class="alert-btn" onclick="handleAlertSignup()">Notify me</button>
      </div>
      <div class="alert-success" id="alertSuccess">You're on the list! We'll let you know when the sky lights up.</div>
    </div>

    <!-- Tours -->
    <div class="section-label">Popular aurora experiences</div>
    <div class="tours-grid">
      <a href="#" class="tour-card" onclick="return false;">
        <div class="tour-icon">‚ô®Ô∏è</div>
        <div class="tour-info"><h3>Chena Hot Springs</h3><p>Soak under the aurora outside Fairbanks. Alaska's top-rated northern lights experience.</p></div>
      </a>
      <a href="#" class="tour-card" onclick="return false;">
        <div class="tour-icon">üì∏</div>
        <div class="tour-info"><h3>Aurora Photography Tours</h3><p>Guided photo tours with warm transport and expert tips. Fairbanks & Anchorage departures.</p></div>
      </a>
      <a href="#" class="tour-card" onclick="return false;">
        <div class="tour-icon">üèîÔ∏è</div>
        <div class="tour-info"><h3>Denali Aurora Lodges</h3><p>Dark sky lodges with aurora wake-up calls. Peak season September through April.</p></div>
      </a>
      <a href="#" class="tour-card" onclick="return false;">
        <div class="tour-icon">üõ∑</div>
        <div class="tour-info"><h3>Dog Sled + Aurora Combo</h3><p>Daytime mushing, evening aurora viewing. The ultimate Alaska bucket list.</p></div>
      </a>
    </div>

    <!-- SEO content -->
    <div class="seo-section">
      <h2>Northern Lights in Alaska ‚Äî What You Need to Know</h2>
      <p>Alaska is one of the best places on Earth to see the aurora borealis, and you don't need a science degree to figure out when to look up. The northern lights happen when charged particles from the sun hit Earth's atmosphere, creating curtains of green, purple, and pink light that dance across the sky.</p>
      <p>How far south the aurora reaches depends on how strong the solar activity is. Fairbanks sits directly under the "auroral oval" and sees aurora on most clear nights from September through April. Anchorage, Palmer, and the Mat-Su Valley need stronger activity but still get spectacular shows several times per month during peak season. Denali and Talkeetna are sweet spots between the two. Juneau and Southeast Alaska need a genuine solar storm, but when it happens, aurora over the ocean is unforgettable.</p>
      <p>Three things matter: strong solar activity (we track this for you), clear skies (we check the forecast), and darkness (aurora is only visible at night). Alaska Glow combines all three into one simple answer for each location.</p>
    </div>
  </div>

  <!-- ==================== LOCATION DETAIL ==================== -->
  <div id="locationDetail" class="location-detail"></div>

  <footer>
    <div>Data from <a href="https://www.swpc.noaa.gov/" target="_blank" rel="noopener">NOAA Space Weather Prediction Center</a> & <a href="https://www.weather.gov/" target="_blank" rel="noopener">National Weather Service</a></div>
    <div style="margin-top:6px;">¬© 2026 Alaska Glow ¬∑ alaskaglow.com</div>
  </footer>
</div>

<script>
// =====================================================================
// LOCATIONS DATABASE
// =====================================================================
const LOCATIONS = [
  {
    id: 'fairbanks', name: 'Fairbanks', lat: 64.84, lon: -147.72,
    kpVisible: 1, kpGood: 3, nwsOffice: 'AFG',
    tagline: 'Under the auroral oval ‚Äî your best bet in Alaska',
    seoTitle: 'Northern Lights in Fairbanks',
    seoDesc: 'Fairbanks sits directly under the auroral oval, making it the best place in Alaska ‚Äî and one of the best on Earth ‚Äî to see the northern lights. Aurora is visible here on most clear nights from September through April, even at low activity levels. The city has built an entire tourism industry around aurora viewing, with lodges, hot springs, and guided photo tours all designed around the lights.',
    spots: [
      { name: 'Chena Hot Springs', desc: 'Iconic. Soak in hot springs while watching aurora overhead. 60 miles northeast of Fairbanks in a natural dark sky area.' },
      { name: 'Cleary Summit', desc: 'Popular local spot on the Steese Highway. High elevation with wide open northern views. Bring a thermos ‚Äî it gets cold.' },
      { name: 'Murphy Dome', desc: 'Old military radar site northwest of town. 360-degree views from the top. Rough road in winter but worth it.' },
      { name: 'Ester Dome', desc: 'Just outside Fairbanks with excellent dark skies. Easy access and popular with photographers.' },
      { name: 'Chena Lakes Recreation Area', desc: 'Close to town with good horizons. Less driving than the summits if you want a quick look.' }
    ]
  },
  {
    id: 'denali', name: 'Denali Area', lat: 63.73, lon: -148.91,
    kpVisible: 2, kpGood: 3, nwsOffice: 'AFG',
    tagline: 'Dark skies and North America\'s tallest peak ‚Äî incredible backdrop',
    seoTitle: 'Northern Lights at Denali',
    seoDesc: 'The Denali area offers some of Alaska\'s most dramatic aurora viewing, with the northern lights dancing above North America\'s tallest peak. The combination of high latitude, minimal light pollution, and stunning mountain scenery makes this a photographer\'s dream. Most Denali lodges outside the park are positioned specifically for aurora viewing with north-facing windows and wake-up call services.',
    spots: [
      { name: 'Denali State Park (Mile 135 Viewpoint)', desc: 'Incredible views of Denali itself with aurora overhead. The overlooks along the Parks Highway have wide open sky.' },
      { name: 'Carlo Creek Area', desc: 'Small community south of Denali park entrance. Very dark, minimal light pollution, and several lodges cater to aurora chasers.' },
      { name: 'Cantwell', desc: 'Tiny community at the junction of the Parks and Denali highways. Extremely dark skies and easy highway access.' },
      { name: 'Wonder Lake (Summer Only)', desc: 'Deep inside the park ‚Äî no light pollution at all. Only accessible late August/September when the park road is open and nights are dark.' }
    ]
  },
  {
    id: 'talkeetna', name: 'Talkeetna', lat: 62.32, lon: -150.11,
    kpVisible: 2, kpGood: 4, nwsOffice: 'AFC',
    tagline: 'Quirky small town, big dark skies, and Denali views',
    seoTitle: 'Northern Lights in Talkeetna',
    seoDesc: 'Talkeetna is a charming small town about two hours north of Anchorage that has become a popular aurora viewing destination. It\'s far enough from Anchorage to escape most light pollution, and on clear nights you can see aurora with Denali as a backdrop. The town has a funky, independent vibe with good restaurants and lodges that make it a more interesting base than just parking on the highway.',
    spots: [
      { name: 'Talkeetna River Bars', desc: 'Walk down to the riverbank for wide open northern views. The gravel bars along the Susitna and Talkeetna rivers are natural dark sky viewing areas.' },
      { name: 'Chase Trail Area', desc: 'South of town with great Denali views. Very few lights and a classic Alaska setting.' },
      { name: 'Petersville Road', desc: 'Heads west from Trapper Creek into the mountains. Gets very dark very fast. Popular with locals who want to escape any ambient light.' }
    ]
  },
  {
    id: 'palmer-wasilla', name: 'Palmer‚ÄìWasilla', lat: 61.60, lon: -149.11,
    kpVisible: 3, kpGood: 5, nwsOffice: 'AFC',
    tagline: 'Mat-Su Valley ‚Äî great viewing away from Anchorage light pollution',
    seoTitle: 'Northern Lights in Palmer & Wasilla',
    seoDesc: 'The Mat-Su Valley towns of Palmer and Wasilla offer a sweet spot for aurora viewing: close enough to Anchorage for easy access but far enough north with less light pollution. You need moderate to strong solar activity (Kp 3+) to see aurora here, but when it happens, the valley\'s wide open agricultural landscapes give you huge sky views that Anchorage can\'t match.',
    spots: [
      { name: 'Hatcher Pass', desc: 'Drive up the road toward Independence Mine for stunning alpine aurora views. High elevation + zero light pollution. Check road conditions ‚Äî upper road closes in winter.' },
      { name: 'Knik River Road', desc: 'Head east from Palmer toward the Knik Glacier. Gets dark quickly once you leave town. Wide river valley views to the north.' },
      { name: 'Bodenburg Butte Trailhead', desc: 'Quick drive from Palmer with good northern horizon. The butte blocks some southern light pollution from Wasilla.' },
      { name: 'Point Mackenzie Road', desc: 'West of Wasilla across the water from Anchorage. Very dark and easy access.' }
    ]
  },
  {
    id: 'anchorage', name: 'Anchorage', lat: 61.22, lon: -149.90,
    kpVisible: 3, kpGood: 5, nwsOffice: 'AFC',
    tagline: 'City lights compete, but strong storms put on a show',
    seoTitle: 'Northern Lights in Anchorage',
    seoDesc: 'Yes, you can see the northern lights from Anchorage ‚Äî but you need to know where to look and when. The city\'s 300,000 residents create significant light pollution, so aurora needs to be moderately strong (Kp 3+) to be visible from town. The trick is getting to the edges of the city where you have dark northern horizons. When a strong storm hits (Kp 5+), aurora can fill the entire sky and you\'ll see it from downtown.',
    spots: [
      { name: 'Glen Alps / Flattop Trailhead', desc: 'Above the city in the Chugach Mountains. Wide open views to the north over Anchorage. Popular and easy to reach.' },
      { name: 'Earthquake Park', desc: 'On the west side of Anchorage overlooking the inlet. Good northern horizon and easy access. Still some city glow but workable during strong events.' },
      { name: 'Kincaid Park', desc: 'Southwest corner of Anchorage on the coast. Dark to the north and west over the inlet. Trails through the woods to open viewpoints.' },
      { name: 'Arctic Valley Road', desc: 'Drive up toward Arctic Valley ski area above Eagle River. Gets above much of the city light. Excellent dark sky spot.' },
      { name: 'Mirror Lake', desc: 'In Eagle River, north of Anchorage proper. Reflections of aurora in calm water if you time it right.' }
    ]
  },
  {
    id: 'kenai', name: 'Kenai Peninsula', lat: 60.55, lon: -151.26,
    kpVisible: 4, kpGood: 5, nwsOffice: 'AFC',
    tagline: 'Needs stronger storms but the coastal backdrop is worth the wait',
    seoTitle: 'Northern Lights on the Kenai Peninsula',
    seoDesc: 'The Kenai Peninsula is farther south than interior Alaska, so you need stronger solar activity to see aurora here ‚Äî generally Kp 4 or higher. But when it happens, the combination of mountains, coastline, and dark skies creates some of the most photogenic aurora scenes in the state. If you\'re visiting Homer, Seward, or Kenai/Soldotna for fishing or scenery and a storm rolls through, you\'re in for a treat.',
    spots: [
      { name: 'Homer Spit', desc: 'Walk out on the spit for 360-degree views over Kachemak Bay. When aurora is strong enough to reach this far south, the reflections on the water are stunning.' },
      { name: 'Turnagain Pass', desc: 'Along the Seward Highway between Anchorage and the peninsula. High elevation, very dark, and surprisingly good aurora viewing.' },
      { name: 'Captain Cook State Recreation Area', desc: 'North of Kenai on the coast. Dark skies and north-facing beaches make this ideal when Kp is high enough.' },
      { name: 'Seward Waterfront', desc: 'Less light pollution than you\'d expect for a port town. Aurora over Resurrection Bay is spectacular during strong events.' }
    ]
  },
  {
    id: 'juneau', name: 'Juneau', lat: 58.30, lon: -134.42,
    kpVisible: 5, kpGood: 6, nwsOffice: 'AJK',
    tagline: 'Southeast Alaska ‚Äî rare but unforgettable when it happens',
    seoTitle: 'Northern Lights in Juneau',
    seoDesc: 'Juneau is the hardest major Alaska city for aurora viewing ‚Äî you need a genuine solar storm (Kp 5+) to see northern lights this far south and east. The frequent cloud cover in Southeast Alaska makes it even trickier. But when a strong geomagnetic storm coincides with clear skies, aurora over the Gastineau Channel and surrounding mountains is absolutely spectacular. It happens a few times per season ‚Äî you just need luck.',
    spots: [
      { name: 'Mendenhall Glacier Visitor Center', desc: 'Open area with northern views toward the glacier. When aurora is visible in Juneau, this is where locals go. Check if the parking area is accessible after hours.' },
      { name: 'Douglas Island', desc: 'Cross the bridge for slightly less city glow. North-facing beaches on Douglas have good horizon views.' },
      { name: 'Out the Road (North Douglas Highway)', desc: 'Drive north along the coast. Gets dark quickly and you have open water views to the north.' },
      { name: 'Eaglecrest Ski Area Road', desc: 'Head up Fish Creek Road on Douglas Island for elevation above any marine fog or low clouds.' }
    ]
  }
];

let allForecasts = [];
let bestSpotId = 'fairbanks';
let currentKp = 0;
let currentBz = 0;
let globalData = null;

// =====================================================================
// DATA FETCHING
// =====================================================================
async function fetchJSON(url) {
  try {
    const controller = new AbortController();
    setTimeout(() => controller.abort(), 8000);
    const res = await fetch(url, { signal: controller.signal });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  } catch(e) {
    console.warn(`Fetch failed: ${url}`, e.message);
    return null;
  }
}

async function loadData() {
  const [kpForecast, kpCurrent, bzData] = await Promise.all([
    fetchJSON('https://services.swpc.noaa.gov/products/noaa-planetary-k-index-forecast.json'),
    fetchJSON('https://services.swpc.noaa.gov/json/planetary_k_index_1m.json'),
    fetchJSON('https://services.swpc.noaa.gov/products/solar-wind/mag-2-hour.json')
  ]);

  if (kpCurrent && kpCurrent.length > 0) {
    const latest = kpCurrent[kpCurrent.length - 1];
    currentKp = latest.estimated_kp || latest.kp_index || 0;
  }

  if (bzData && bzData.length > 1) {
    const latest = bzData[bzData.length - 1];
    currentBz = parseFloat(latest[3]) || 0;
  }

  let forecastEntries = [];
  if (kpForecast && kpForecast.length > 1) {
    for (let i = 1; i < kpForecast.length; i++) {
      const row = kpForecast[i];
      const kpVal = parseFloat(row[1]);
      if (!isNaN(kpVal)) {
        forecastEntries.push({
          time: new Date(row[0] + ' UTC'),
          kp: kpVal,
          type: row[2]
        });
      }
    }
  }

  const now = new Date();
  const akOffset = getAKOffset(now);
  const akNow = new Date(now.getTime() + akOffset * 3600000);
  const tonight = getTonightWindow(akNow, 64.84, -147.72);

  let tonightMaxKp = currentKp;
  for (const entry of forecastEntries) {
    const entryAK = new Date(entry.time.getTime() + akOffset * 3600000);
    if (entryAK >= tonight.start && entryAK <= tonight.end) {
      if (entry.kp > tonightMaxKp) tonightMaxKp = entry.kp;
    }
  }
  if (tonightMaxKp === 0) tonightMaxKp = currentKp;

  // Multi-night Kp
  const nightMaxKps = [tonightMaxKp];
  for (let dayOffset = 1; dayOffset <= 2; dayOffset++) {
    const futureAK = new Date(akNow);
    futureAK.setDate(futureAK.getDate() + dayOffset);
    futureAK.setHours(14, 0, 0, 0);
    const futureNight = getTonightWindow(futureAK, 64.84, -147.72);
    let maxKp = 0;
    for (const entry of forecastEntries) {
      const entryAK = new Date(entry.time.getTime() + akOffset * 3600000);
      if (entryAK >= futureNight.start && entryAK <= futureNight.end) {
        if (entry.kp > maxKp) maxKp = entry.kp;
      }
    }
    nightMaxKps.push(maxKp);
  }

  // Last night's max Kp (for "was last night good" section)
  const yesterdayAK = new Date(akNow);
  yesterdayAK.setDate(yesterdayAK.getDate() - 1);
  yesterdayAK.setHours(14, 0, 0, 0);
  const lastNight = getTonightWindow(yesterdayAK, 64.84, -147.72);
  let lastNightMaxKp = 0;
  for (const entry of forecastEntries) {
    const entryAK = new Date(entry.time.getTime() + akOffset * 3600000);
    if (entryAK >= lastNight.start && entryAK <= lastNight.end) {
      if (entry.kp > lastNightMaxKp) lastNightMaxKp = entry.kp;
    }
  }

  return { forecastEntries, tonightMaxKp, nightMaxKps, lastNightMaxKp, akNow };
}

// =====================================================================
// ALASKA TIME
// =====================================================================
function getAKOffset(date) {
  const year = date.getUTCFullYear();
  const marchSecondSun = new Date(Date.UTC(year, 2, 8 + (7 - new Date(Date.UTC(year, 2, 8)).getUTCDay()) % 7, 11));
  const novFirstSun = new Date(Date.UTC(year, 10, 1 + (7 - new Date(Date.UTC(year, 10, 1)).getUTCDay()) % 7, 10));
  return (date >= marchSecondSun && date < novFirstSun) ? -8 : -9;
}

function getTonightWindow(akNow, lat, lon) {
  const today = new Date(akNow); today.setHours(12, 0, 0, 0);
  const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
  const sunToday = SunCalc.getTimes(today, lat, lon);
  const sunTomorrow = SunCalc.getTimes(tomorrow, lat, lon);
  return {
    start: sunToday.nauticalDusk || sunToday.sunset,
    end: sunTomorrow.nauticalDawn || sunTomorrow.sunrise
  };
}

function formatAKTime(date) {
  return date.toLocaleTimeString('en-US', { timeZone: 'America/Anchorage', hour: 'numeric', minute: '2-digit', hour12: true });
}

// =====================================================================
// SCORING
// =====================================================================
function scoreForLocation(loc, maxKp, bz) {
  let score = 0;
  if (maxKp >= loc.kpGood + 2) score += 60;
  else if (maxKp >= loc.kpGood) score += 50;
  else if (maxKp >= loc.kpVisible + 1) score += 35;
  else if (maxKp >= loc.kpVisible) score += 20;
  else score += 5;

  if (bz < -10) score += 20;
  else if (bz < -5) score += 12;
  else if (bz < 0) score += 5;
  score += 20; // darkness bonus

  let level, levelLabel;
  if (score >= 65) { level = 'great'; levelLabel = 'Great chance'; }
  else if (score >= 40) { level = 'possible'; levelLabel = 'Possible'; }
  else if (score >= 25) { level = 'cloudy'; levelLabel = 'Worth checking'; }
  else { level = 'unlikely'; levelLabel = 'Unlikely'; }

  const now = new Date();
  const akOffset = getAKOffset(now);
  const akNow = new Date(now.getTime() + akOffset * 3600000);
  const darkWindow = getTonightWindow(akNow, loc.lat, loc.lon);
  const verdict = makeVerdict(loc, maxKp, bz, level);

  return { ...loc, score, level, levelLabel, verdict, kp: maxKp, darkWindow };
}

function makeVerdict(loc, kp, bz, level) {
  if (level === 'great') {
    if (kp >= loc.kpGood + 2) return `Strong solar activity tonight ‚Äî expect vivid, dancing aurora. ${loc.name} needs Kp ${loc.kpVisible} and we're well above that.`;
    return `Conditions look good tonight. Look north after dark for a solid display.`;
  }
  if (level === 'possible') {
    if (kp >= loc.kpVisible + 1) return `Activity is above the threshold for ${loc.name}. You might catch a glow on the horizon ‚Äî worth stepping outside.`;
    if (bz < -5) return `Solar wind is favorable even though activity is moderate. Could surprise you tonight.`;
    return `Moderate activity ‚Äî a faint display is possible. Keep an eye out after dark.`;
  }
  if (level === 'cloudy') {
    if (kp >= loc.kpVisible) return `Activity is right at the edge for ${loc.name}. Quick check outside after dark ‚Äî you might get lucky.`;
    return `Activity is a bit low for here, but conditions can change fast. Not impossible.`;
  }
  return `Activity is below what ${loc.name} typically needs. Probably quiet tonight, but check back ‚Äî storms ramp up fast.`;
}

function getOutlookLevel(kp) {
  if (kp >= 5) return { level: 'great', label: 'Great chance', desc: 'Strong activity expected' };
  if (kp >= 4) return { level: 'possible', label: 'Good chance', desc: 'Moderate to strong activity' };
  if (kp >= 3) return { level: 'possible', label: 'Possible', desc: 'Some activity expected' };
  if (kp >= 2) return { level: 'cloudy', label: 'Maybe', desc: 'Mild activity ‚Äî northern areas likely' };
  if (kp > 0) return { level: 'unlikely', label: 'Quiet', desc: 'Low activity expected' };
  return { level: 'unlikely', label: 'No data', desc: 'Forecast not yet available' };
}

// =====================================================================
// RENDER DASHBOARD
// =====================================================================
function renderDashboard(forecasts, data) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';

  forecasts.sort((a, b) => b.score - a.score);
  allForecasts = forecasts;
  bestSpotId = forecasts[0].id;

  const updateTime = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Anchorage', hour: 'numeric', minute: '2-digit', hour12: true });
  document.getElementById('lastUpdated').textContent = `Updated ${updateTime} Alaska time`;

  // Hero
  const best = forecasts[0];
  const heroEl = document.getElementById('heroCard');
  heroEl.className = `hero level-${best.level}`;
  heroEl.onclick = () => navigateTo(best.id);
  document.getElementById('heroLocation').textContent = best.name;
  document.getElementById('heroVerdict').textContent = best.verdict;
  document.getElementById('heroDetail').innerHTML = `<strong>Dark window:</strong> ${formatAKTime(best.darkWindow.start)} ‚Äì ${formatAKTime(best.darkWindow.end)}`;

  // 3-night outlook
  renderOutlook(data);

  // Location cards
  const grid = document.getElementById('locationsGrid');
  grid.innerHTML = '';
  for (const f of forecasts) {
    const card = document.createElement('div');
    card.className = `location-card level-${f.level}`;
    card.onclick = () => navigateTo(f.id);
    card.innerHTML = `
      <div class="card-header">
        <div class="card-location-name">${f.name}</div>
        <div class="card-indicator"></div>
      </div>
      <div class="card-verdict">${f.verdict}</div>
      <div class="card-meta">
        <span>üåô Dark by ${formatAKTime(f.darkWindow.start)}</span>
        <span>${f.levelLabel}</span>
      </div>`;
    grid.appendChild(card);
  }

  // Was last night good?
  renderLastNight(data);

  // Forecast chart
  renderForecastChart(data.forecastEntries);
}

function renderOutlook(data) {
  const strip = document.getElementById('outlookStrip');
  strip.innerHTML = '';
  const now = new Date();
  const akOffset = getAKOffset(now);
  const akNow = new Date(now.getTime() + akOffset * 3600000);
  const labels = ['Tonight', 'Tomorrow Night', ''];
  const day3 = new Date(akNow); day3.setDate(day3.getDate() + 2);
  labels[2] = day3.toLocaleDateString('en-US', { weekday: 'long', timeZone: 'America/Anchorage' }) + ' Night';

  for (let i = 0; i < 3; i++) {
    const o = getOutlookLevel(data.nightMaxKps[i] || 0);
    const card = document.createElement('div');
    card.className = 'outlook-card' + (i === 0 ? ' is-tonight' : '');
    card.innerHTML = `<div class="outlook-day">${labels[i]}</div><div class="outlook-indicator level-${o.level}"></div><div class="outlook-label">${o.label}</div><div class="outlook-desc">${o.desc}</div>`;
    strip.appendChild(card);
  }
}

function renderLastNight(data) {
  const section = document.getElementById('lastnightSection');
  const kp = data.lastNightMaxKp;
  if (kp <= 0) { section.style.display = 'none'; return; }
  section.style.display = 'block';
  const title = document.getElementById('lastnightTitle');
  const desc = document.getElementById('lastnightDesc');

  if (kp >= 5) {
    title.textContent = 'üåå Last night was a strong aurora night!';
    desc.textContent = `Activity peaked at Kp ${kp.toFixed(1)} overnight ‚Äî that's a solid geomagnetic storm. Aurora was likely visible across most of Alaska, including Anchorage and the Kenai Peninsula. If you were out and saw it, nice catch!`;
  } else if (kp >= 3) {
    title.textContent = 'üåå Last night had some aurora activity';
    desc.textContent = `Activity reached Kp ${kp.toFixed(1)} overnight. Fairbanks and Denali probably had a good show. If you missed it, tonight's forecast is above ‚Äî check if you get another shot.`;
  } else {
    title.textContent = 'üåå Quiet night last night';
    desc.textContent = `Activity only reached Kp ${kp.toFixed(1)} ‚Äî mostly too low for visible aurora except possibly in Fairbanks. Conditions change daily though.`;
  }
}

function renderForecastChart(entries) {
  const chart = document.getElementById('forecastChart');
  const legend = document.getElementById('forecastLegend');
  chart.innerHTML = '';

  if (!entries || entries.length === 0) {
    chart.innerHTML = '<div class="forecast-empty">Forecast data is loading from NOAA ‚Äî this sometimes takes a moment. Refresh to try again.</div>';
    legend.style.display = 'none';
    return;
  }

  const now = new Date();
  const windowStart = new Date(now.getTime() - 12 * 3600000);
  const windowEnd = new Date(now.getTime() + 72 * 3600000);
  const filtered = entries.filter(e => e.time >= windowStart && e.time <= windowEnd);
  const toShow = filtered.slice(0, 32);

  if (toShow.length === 0) {
    chart.innerHTML = '<div class="forecast-empty">No forecast data available for the next 3 days right now. NOAA data refreshes periodically.</div>';
    legend.style.display = 'none';
    return;
  }

  legend.style.display = 'flex';
  const refLat = 64.84, refLon = -147.72;

  for (let idx = 0; idx < toShow.length; idx++) {
    const entry = toShow[idx];
    const group = document.createElement('div');
    group.className = 'forecast-bar-group';
    const bar = document.createElement('div');
    const kp = entry.kp;
    bar.style.height = Math.max(5, (kp / 9) * 100) + '%';
    if (kp >= 6) bar.className = 'forecast-bar kp-storm';
    else if (kp >= 4) bar.className = 'forecast-bar kp-high';
    else if (kp >= 2) bar.className = 'forecast-bar kp-mod';
    else bar.className = 'forecast-bar kp-low';

    const sunTimes = SunCalc.getTimes(entry.time, refLat, refLon);
    const isNight = entry.time < sunTimes.sunrise || entry.time > sunTimes.sunset;
    bar.classList.add(isNight ? 'is-night' : 'is-day');
    bar.title = `${entry.time.toLocaleString('en-US',{timeZone:'America/Anchorage',month:'short',day:'numeric',hour:'numeric',hour12:true})} ‚Äî Kp ${kp.toFixed(1)}${isNight?' (dark)':' (daylight)'}`;
    group.appendChild(bar);

    if (idx % 4 === 0) {
      const lbl = document.createElement('div');
      lbl.className = 'forecast-time' + (isNight && Math.abs(entry.time - now) < 18*3600000 ? ' is-tonight' : '');
      lbl.textContent = entry.time.toLocaleDateString('en-US',{timeZone:'America/Anchorage',weekday:'short'}) + ' ' + entry.time.toLocaleTimeString('en-US',{timeZone:'America/Anchorage',hour:'numeric',hour12:true});
      group.appendChild(lbl);
    }
    chart.appendChild(group);
  }
}

// =====================================================================
// LOCATION DETAIL PAGE
// =====================================================================
function renderLocationDetail(locationId) {
  const f = allForecasts.find(l => l.id === locationId);
  if (!f) return;

  document.getElementById('dashboard').style.display = 'none';
  const detail = document.getElementById('locationDetail');
  detail.className = 'location-detail active';

  // Build spots HTML
  let spotsHTML = '';
  if (f.spots && f.spots.length > 0) {
    spotsHTML = `<div class="info-card">
      <h3>üìç Best viewing spots</h3>
      <ul class="spot-list">
        ${f.spots.map(s => `<li><div class="spot-name">${s.name}</div><div class="spot-desc">${s.desc}</div></li>`).join('')}
      </ul>
    </div>`;
  }

  // Other locations chips
  const others = allForecasts.filter(l => l.id !== locationId);
  const chipsHTML = others.map(o => {
    const dotColor = o.level === 'great' ? 'var(--green-glow)' : o.level === 'possible' ? 'var(--yellow-glow)' : o.level === 'cloudy' ? 'var(--orange-glow)' : 'var(--red-glow)';
    return `<div class="other-loc-chip" onclick="navigateTo('${o.id}')"><div class="chip-dot" style="background:${dotColor}"></div>${o.name}</div>`;
  }).join('');

  // 3-night outlook specific to this location
  let outlookHTML = '';
  if (globalData && globalData.nightMaxKps) {
    const nights = ['Tonight', 'Tomorrow', ''];
    const akNow = globalData.akNow;
    const d3 = new Date(akNow); d3.setDate(d3.getDate() + 2);
    nights[2] = d3.toLocaleDateString('en-US', { weekday: 'short', timeZone: 'America/Anchorage' });

    outlookHTML = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:20px;">';
    for (let i = 0; i < 3; i++) {
      const nkp = globalData.nightMaxKps[i] || 0;
      // Score against THIS location's thresholds
      let nlevel;
      if (nkp >= f.kpGood) nlevel = 'great';
      else if (nkp >= f.kpVisible + 1) nlevel = 'possible';
      else if (nkp >= f.kpVisible) nlevel = 'cloudy';
      else nlevel = 'unlikely';
      const nlabel = nlevel === 'great' ? 'Great' : nlevel === 'possible' ? 'Possible' : nlevel === 'cloudy' ? 'Maybe' : 'Unlikely';
      const dotColor = nlevel === 'great' ? 'var(--green-glow)' : nlevel === 'possible' ? 'var(--yellow-glow)' : nlevel === 'cloudy' ? 'var(--orange-glow)' : 'var(--red-glow)';
      outlookHTML += `<div style="text-align:center;"><div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.06em;">${nights[i]}</div><div style="width:14px;height:14px;border-radius:50%;background:${dotColor};margin:0 auto 6px;box-shadow:0 0 10px ${dotColor};"></div><div style="font-size:0.82rem;font-weight:500;">${nlabel}</div></div>`;
    }
    outlookHTML += '</div>';
  }

  detail.innerHTML = `
    <button class="back-btn" onclick="navigateTo('')">‚Üê All locations</button>
    <div class="other-locations">${chipsHTML}</div>

    <div class="detail-hero level-${f.level}">
      <div class="detail-location-name">${f.name}</div>
      <div class="detail-verdict-large">${f.verdict}</div>
      <div class="detail-stats">
        <div class="detail-stat"><div class="detail-stat-value">${f.levelLabel}</div><div class="detail-stat-label">Tonight</div></div>
        <div class="detail-stat"><div class="detail-stat-value">${formatAKTime(f.darkWindow.start)}</div><div class="detail-stat-label">Gets dark</div></div>
        <div class="detail-stat"><div class="detail-stat-value">Kp ${f.kpVisible}+</div><div class="detail-stat-label">Min needed</div></div>
      </div>
      ${outlookHTML}
      <button class="share-btn" onclick="shareForecast('${f.id}')">üì§ Share tonight's forecast</button>
    </div>

    ${spotsHTML}

    <div class="info-card">
      <h3>üåô Best viewing window tonight</h3>
      <p>${formatAKTime(f.darkWindow.start)} to ${formatAKTime(f.darkWindow.end)}. The darkest hours (usually 11 PM ‚Äì 3 AM) tend to be best, but aurora can appear any time it's dark. Give your eyes 15‚Äì20 minutes to adjust. Your phone camera will often pick up aurora before your eyes do ‚Äî try a long-exposure shot if you're not sure.</p>
    </div>

    <div class="info-card">
      <h3>üèîÔ∏è About this location</h3>
      <p>${f.seoDesc}</p>
    </div>

    <div class="info-card detail-nerd" onclick="this.querySelector('.nerd-data').style.display=this.querySelector('.nerd-data').style.display==='block'?'none':'block'">
      <h3>üî¨ Technical details <span style="font-weight:300;color:var(--text-muted);font-size:0.8rem">(tap to expand)</span></h3>
      <div class="nerd-data">
        <p>
          <strong>Current Kp:</strong> ${currentKp.toFixed(1)}<br>
          <strong>Tonight's forecast Kp:</strong> ${f.kp.toFixed(1)}<br>
          <strong>Min Kp for visibility:</strong> ${f.kpVisible}<br>
          <strong>Kp for strong display:</strong> ${f.kpGood}<br>
          <strong>Solar wind Bz:</strong> ${currentBz.toFixed(1)} nT ${currentBz < -5 ? '(southward ‚Äî favorable)' : currentBz < 0 ? '(slightly southward ‚Äî neutral)' : '(northward ‚Äî less favorable)'}<br>
          <strong>Composite score:</strong> ${f.score}/100<br>
          <strong>Coordinates:</strong> ${f.lat}¬∞N, ${Math.abs(f.lon)}¬∞W
        </p>
      </div>
    </div>

    <div class="alert-section" style="margin-top:24px;">
      <div class="alert-title">Get ${f.name} aurora alerts</div>
      <div class="alert-desc">We'll email you when conditions look great here.</div>
      <div class="alert-form">
        <input type="email" class="alert-input" placeholder="your@email.com" id="alertEmailDetail">
        <button class="alert-btn" onclick="handleAlertSignupDetail('${f.id}')">Notify me</button>
      </div>
    </div>
  `;

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// =====================================================================
// NAVIGATION (hash-based)
// =====================================================================
function navigateTo(locationId) {
  if (locationId) {
    window.location.hash = '#/' + locationId;
  } else {
    window.location.hash = '';
    document.getElementById('locationDetail').className = 'location-detail';
    document.getElementById('dashboard').style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

function handleHashChange() {
  const hash = window.location.hash;
  if (hash.startsWith('#/')) {
    const locId = hash.slice(2);
    if (allForecasts.length > 0 && allForecasts.find(l => l.id === locId)) {
      renderLocationDetail(locId);
      // Update page title for SEO/sharing
      const loc = LOCATIONS.find(l => l.id === locId);
      if (loc) document.title = `${loc.seoTitle} ‚Äî Alaska Glow`;
    }
  } else {
    document.getElementById('locationDetail').className = 'location-detail';
    if (allForecasts.length > 0) {
      document.getElementById('dashboard').style.display = 'block';
    }
    document.title = 'Alaska Glow ‚Äî Aurora Forecast for Tonight';
  }
}

window.addEventListener('hashchange', handleHashChange);

// =====================================================================
// SHARING
// =====================================================================
async function shareForecast(locationId) {
  const f = allForecasts.find(l => l.id === locationId);
  if (!f) return;
  const text = `Aurora forecast for ${f.name} tonight: ${f.levelLabel} ‚Äî ${f.verdict.split('.')[0]}.\n\nCheck conditions ‚Üí alaskaglow.com/#/${f.id}`;
  if (navigator.share) {
    try { await navigator.share({ title: `Aurora Forecast ‚Äî ${f.name}`, text, url: `https://alaskaglow.com/#/${f.id}` }); } catch(e) {}
  } else {
    try { await navigator.clipboard.writeText(text); alert('Forecast copied to clipboard!'); } catch(e) {}
  }
}

// =====================================================================
// ALERT SIGNUPS
// =====================================================================
function handleAlertSignup() {
  const email = document.getElementById('alertEmail').value;
  if (!email || !email.includes('@')) { alert('Please enter a valid email.'); return; }
  const signups = JSON.parse(localStorage.getItem('ag_signups') || '[]');
  signups.push({ email, location: 'all', date: new Date().toISOString() });
  localStorage.setItem('ag_signups', JSON.stringify(signups));
  document.getElementById('alertForm').style.display = 'none';
  document.getElementById('alertSuccess').style.display = 'block';
}

function handleAlertSignupDetail(locId) {
  const input = document.getElementById('alertEmailDetail');
  if (!input) return;
  const email = input.value;
  if (!email || !email.includes('@')) { alert('Please enter a valid email.'); return; }
  const signups = JSON.parse(localStorage.getItem('ag_signups') || '[]');
  signups.push({ email, location: locId, date: new Date().toISOString() });
  localStorage.setItem('ag_signups', JSON.stringify(signups));
  input.parentElement.innerHTML = '<div style="color:var(--aurora-green);font-size:0.9rem;margin-top:8px;">You\'re on the list!</div>';
}

// =====================================================================
// STARS
// =====================================================================
function generateStars() {
  const c = document.getElementById('stars');
  for (let i = 0; i < 80; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    s.style.left = Math.random()*100+'%';
    s.style.top = Math.random()*60+'%';
    s.style.animationDelay = Math.random()*3+'s';
    s.style.animationDuration = (2+Math.random()*3)+'s';
    s.style.width = s.style.height = (1+Math.random()*1.5)+'px';
    c.appendChild(s);
  }
}

// =====================================================================
// INIT
// =====================================================================
async function init() {
  generateStars();
  try {
    const data = await loadData();
    globalData = data;
    const forecasts = LOCATIONS.map(loc => scoreForLocation(loc, data.tonightMaxKp, currentBz));
    renderDashboard(forecasts, data);
    // Check if URL has a location hash
    handleHashChange();
  } catch(e) {
    console.error('Init error:', e);
    document.getElementById('loading').innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary);"><h2 style="font-size:1.1rem;margin-bottom:8px;">Couldn\'t load aurora data</h2><p style="color:var(--text-muted);">NOAA servers may be temporarily unavailable. Refresh to try again.</p></div>';
  }
}

init();
</script>
</body>
</html>
